<!DOCTYPE html>
<html>
    <head>
        <title>Point Cloud on globe</title>

        <style type="text/css">
            #info {
                color: #7ad7ff;
                font-family: 'Open Sans', sans-serif;
                position: absolute;
                top: 0;
                left: 0;
                padding: 0.3rem;
                background-color: #404040;
                z-index: 1;
            }

            @media (max-width: 600px) {
                #info,
                .dg {
                    display: none;
                }
            }
        </style>

        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="css/example.css">
        <link rel="stylesheet" type="text/css" href="css/LoadingScreen.css">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div id="viewerDiv"></div>
        <div id="info"></div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.6/dat.gui.min.js"></script>
        <script src="../dist/itowns.js"></script>
        <script src="js/GUI/LoadingScreen.js"></script>
        <script src="../dist/debug.js"></script>
        <script src="js/GUI/GuiTools.js"></script>
        <script type="text/javascript">
            window.THREE = itowns.THREE;
        </script>
        <script type="text/javascript">
            var viewerDiv;
            var debugGui;
            var view;
            var debugMenu;
            var viewExtent;

            viewerDiv = document.getElementById('viewerDiv');
            viewerDiv.style.display = 'block';

            debugGui = new dat.GUI();

            // Define crs projection that we will use (taken from https://epsg.io/3946, Proj4js section)
            itowns.proj4.defs('EPSG:3947', '+proj=lcc +lat_0=47 +lon_0=3 +lat_1=46.25 +lat_2=47.75 +x_0=1700000 +y_0=6200000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs');
            itowns.proj4.defs('EPSG:2154', '+proj=lcc +lat_1=49 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');

            let extentSize = 100;
            const viewExtentEPSG = "EPSG:3947";
            const orthoEPSG = viewExtentEPSG;
            const centerCoord = new itowns.Coordinates("EPSG:3947", 1351152.118201931, 6240395.0059363097, 61.329999999999998);

            var customRenderer = createRenderer();

            let layerOrtho;
            let layerDEM;

            loadView();

            function createRenderer() {
                const renderer = new THREE.WebGLRenderer({
                    alpha: true,
                    antialias: true,
                    powerPreference: "high-performance",
                    preserveDrawingBuffer: true
                });
                renderer.setSize(viewerDiv.clientWidth, viewerDiv.clientHeight);
                renderer.setPixelRatio(window.devicePixelRatio);

                viewerDiv.appendChild(renderer.domElement);

                return renderer;
            }

            function createExtent() {
                let extentCoord1 = new itowns.Coordinates(centerCoord.crs, centerCoord.x - extentSize, centerCoord.y - extentSize);
                let extentCoord2 = new itowns.Coordinates(centerCoord.crs, centerCoord.x + extentSize, centerCoord.y + extentSize);

                extentCoord1 = extentCoord1.as(viewExtentEPSG);
                extentCoord2 = extentCoord2.as(viewExtentEPSG);

                return new itowns.Extent(
                    viewExtentEPSG,
                    extentCoord1.x, extentCoord2.x,
                    extentCoord1.y, extentCoord2.y
                );
            }

            function loadView() {
                viewExtent = createExtent();

                view = new itowns.PlanarView(
                    viewerDiv,
                    viewExtent,
                    {
                        renderer: customRenderer
                    });

                customRenderer.setClearColor(0x000000, 0);
                setupLoadingScreen(viewerDiv, view);
                window.view = view;
                debugMenu = new GuiTools('menuDiv', view);

                Promise.all([
                    loadElevation(),
                    loadOrtho(),
                ])
                    .then(onAllLoaded);
            }

            function loadElevation() {
                // Define the source of the dem data
                const sourceDEM = new itowns.WMSSource({
                    url: "https://data.geopf.fr/wms-r/wms?",
                    name: "ELEVATION.ELEVATIONGRIDCOVERAGE.HIGHRES",
                    format: "image/x-bil;bits=32",
                    crs: 'EPSG:2154',
                    extent: viewExtent,
                });
                // Create the dem ElevationLayer and add it to the view
                layerDEM = new itowns.ElevationLayer('Elevation', { source: sourceDEM });
                return view.addLayer(layerDEM);
            }

            function loadOrtho() {
                let sourceMap = new itowns.WMSSource({
                    url: "https://data.geopf.fr/wms-r",
                    name: "OI.OrthoimageCoverage.HR",
                    format: "image/png",
                    crs: orthoEPSG,
                    extent: viewExtent
                });

                // Create the ortho-images ColorLayer and add it to the view
                layerOrtho = new itowns.ColorLayer('Ortho', { source: sourceMap });
                return view.addLayer(layerOrtho);
            }

            function onAllLoaded() {
                debugMenu.addImageryLayersGUI([layerOrtho]);
                debugMenu.addElevationLayerGUI(layerDEM);

                debugMenu.resizeViewExtent = function() {
                    console.log("Resize view extent");
                    view.dispose();
                    extentSize = extentSize * 2;
                    loadView();
                };

                debugMenu.gui.add(debugMenu, 'resizeViewExtent').name('Resize view extent');
            }
        </script>
    </body>
</html>

